# 第4章 课程发布

## 需求分析

### 背景

​		课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者通过学成在线平台的网站可以搜索到课程，然后查看课程的详细信息，选课、学习。为了课程内容没有违规信息、课程内容安排合理，在课程发布之间平台运营方会进行课程审核，审核通过后课程方可发布。作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。

课程预览入口

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-1.png){width="5.90625in" height="4.885416666666667in"}

课程详情（预览）

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448.png){width="5.90625in" height="5.03125in"}

### 业务流程

课程预览 => 课程审核 => 课程发布

#### 课程预览

教育机构用户 在课程管理中可对该机构内所管理的课程进行检索。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-2.png){width="5.90625in" height="1.4791666666666667in"}

点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面效果。

下图是课程详情首页，显示了课程的基本。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-3.png){width="5.90625in" height="4.34375in"}

点击课程目录，显示课程计划，通过此界面去核实课程计划的信息是否存在问题。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-4.png){width="5.90625in" height="4.177083333333333in"}

点击课程目录中的具体章节，查看视频播放是否正常

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-5.png){width="5.90625in" height="2.8125in"}

#### 课程审核

教学机构提交课程审核后，平台运营人员登录运营平台查询待审核的记录。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-6.png){width="5.90625in" height="2.0104166666666665in"}

具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。

如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。

如果课程内容没有违规信息且课程内容全面则审核通过。

课程审核通过后教学机构发布课程成功。



#### 课程发布

教育机构用户在课程管理中可对机构内课程进行检索。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-7.png){width="5.90625in" height="1.5104166666666667in"}

点击某课程数据后的 发布 链接（审核状态为通过），即可对该课程进行发布。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-8.png){width="5.90625in" height="1.5520833333333333in"}

课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-9.png){width="5.90625in" height="3.8229166666666665in"}

点击课程搜索页中课程列表的某个课程，可进入课程详情页。

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-3.png){width="5.90625in" height="4.34375in"}



#### 课程搜索





## 详细设计与开发

### 课程预览

#### 分析

在课程预览页面点击\"视频播放图片\"打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题。课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览

#### 流程图

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-11.png){width="5.90625in" height="2.5208333333333335in"}

#### 约束逻辑

1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。

2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。

3、通过课程预览页面点击"马上学习"打开视频播放页面。

4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资管理查询课程计划绑定的视频文件地址，在浏览播放视频。

#### 技术调研

要求：门户域名访问，访问快，界面，详情一致

联想：静态网页=> 模板引擎

模板引擎：Jsp、Freemarker、Thymeleaf 、Velocity 等。

优缺点：https://www.cnblogs.com/ywb-articles/p/10627398.html

使用成本考虑：（会使用Freemarker，其它不会）

最终决定：采用Freemarker作为项目的模板引擎技术使用。

**Freemarker集成DEMO**

下边在内容管理接口层搭建Freemarker的运行环境并进行测试。

在内容管理接口工层 添加Freemarker与SpringBoot的整合包

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-freemarker</artifactId>
</dependency>
```

yml配置

```yaml
spring:
  freemarker:
    enabled: true
    cache: false
    settings:
      template_update_delay: 0
    suffix: .ftl
    charset: utf-8
    template-loader-path: classpath:/templates/
    resources:
      # 关闭项目中的静态资源映射(static、resources文件夹下的资源)
      add-mappings: false
```

添加模板，在resources下创建templates目录，添加test.ftl模板文件

```html
<!DOCTYPE html\>
<html\>
<head\>
<meta charset="utf-8"\>
<title\>Hello World!</title\>
</head\>
<body\>
  Hello ${name}!
</body\>
</html\>
```

新建个模板测试Controller : FreemarkerController ,存放模型数据测试方法

```java
@GetMapping("/testfreemarker")
public ModelAndView test(){
  ModelAndView modelAndView = new ModelAndView();
  //设置模型数据
  modelAndView.addObject("name","小明");
  //设置模板名称
  modelAndView.setViewName("test");
  return modelAndView;
}
```

启动内容管理接口工程，访问http://localhost:63040/content/testfreemarker

屏幕输出：Hello 小明！

freemarker提供很多指令用于解析各种类型的数据模型

参考地址：http://freemarker.foofun.cn/ref_directives.html

#### 接口开发

在CoursePublishController

```java
@Controller
public class CoursePublishController {
}
```

##### 定义接口

```java
@Resource
private CoursePublishService coursePublishService;
@ApiOperation("课程预览信息接口")
@GetMapping("/coursepreview/{courseId}")
public ModelAndView preview(@PathVariable("courseId") Long courseId) {
    ModelAndView modelAndView = new ModelAndView();
    modelAndView.addObject("model", coursePublishService.getCoursePreviewDto(courseId));
    modelAndView.setViewName("course_template");
    return modelAndView;
}
```

准备添加freemarker标签好的模板文件course_template.ftl 放在templates下

##### 添加模板

course_template.ftl

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/static/img/asset-favicon.ico">
    <title>学成在线-${model.courseBase.name}</title>

    <link rel="stylesheet" href="/static/plugins/normalize-css/normalize.css"/>
    <link rel="stylesheet" href="/static/plugins/bootstrap/dist/css/bootstrap.css"/>
    <link rel="stylesheet" href="/static/css/page-learing-article.css"/>
</head>

<body data-spy="scroll" data-target="#articleNavbar" data-offset="150">
<!-- 页面头部 -->
<!--#include virtual="/include/header.html"-->
<!--页面头部结束sss-->
<div id="learningArea">
    <div class="article-banner">
        <div class="banner-bg"></div>
        <div class="banner-info">
            <div class="banner-left">
                <p>${model.courseBase.mtName}<span>\ ${model.courseBase.stName}</span></p>
                <p class="tit">${model.courseBase.name}</p>
                <p class="pic">
                    <#if model.courseBase.charge=='201000'>
                        <span class="new-pic">免费</span>
                    <#else>
                        <span class="new-pic">特惠价格￥${model.courseBase.price!''}</span>
                        <span class="old-pic">原价￥${model.courseBase.originalPrice!''}</span>
                    </#if>
                </p>
                <p class="info">
                    <a href="#" @click.prevent="startLearning()">马上学习</a>
                    <span><em>难度等级</em>
                <#if model.courseBase.grade=='204001'>
                    初级
                <#elseif model.courseBase.grade=='204002'>
                    中级
                <#elseif model.courseBase.grade=='204003'>
                    高级
                </#if>
                </span>
                    <span><em>课程时长</em>2小时27分</span>
                    <span><em>评分</em>4.7分</span>
                    <span><em>授课模式</em>
                 <#if model.courseBase.teachmode=='200002'>
                     录播
                 <#elseif model.courseBase.teachmode=='200003'>
                     直播
                 </#if>
                </span>
                </p>
            </div>
            <div class="banner-rit">
                <p>
                    <a href="http://www.xuecheng-plus.com/course/preview/learning.html?id=${model.courseBase.id}"
                       target="_blank">
                        <#if model.courseBase.pic??>
                            <img src="http://file.xuecheng-plus.com${model.courseBase.pic}" alt="" width="270"
                                 height="156">
                        <#else>
                            <img src="/static/img/widget-video.png" alt="" width="270" height="156">
                        </#if>

                    </a>
                </p>
                <p class="vid-act"><span> <i class="i-heart"></i>收藏 23 </span> <span>分享 <i class="i-weixin"></i><i
                                class="i-qq"></i></span></p>
            </div>
        </div>
    </div>
    <div class="article-cont">
        <div id="tits" class="tit-list">
            <a href="javascript:;" id="articleClass" class="active">课程介绍</a>
            <a href="javascript:;" id="articleItem">目录</a>
            <a href="javascript:;" id="artcleAsk">问答</a>
            <a href="javascript:;" id="artcleNot">笔记</a>
            <a href="javascript:;" id="artcleCod">评价</a>
        </div>
        <div id="articles" class="article-box">
            <div class="articleClass" style="display: block">
                <!--<div class="rit-title">评价</div>-->
                <div class="article-cont">
                    <div class="article-left-box">
                        <div class="content">

                            <div class="content-com suit">
                                <div class="title"><span>适用人群</span></div>
                                <div class="cont cktop">
                                    <div>
                                        <p>${model.courseBase.users!""}</p>
                                    </div>
                                    <!--<span class="on-off">更多 <i class="i-chevron-bot"></i></span>-->
                                </div>
                            </div>
                            <div class="content-com course">
                                <div class="title"><span>课程制作</span></div>
                                <div class="cont">
                                    <div class="img-box"><img src="/static/img/widget-myImg.jpg" alt=""></div>
                                    <div class="info-box">
                                        <p class="name">教学方：<em>XX老师</em></p>
                                        <!-- <p class="lab">高级前端开发工程师 10年开发经验</p>-->
                                        <p class="info">
                                            JavaEE开发与教学多年，精通JavaEE技术体系，对流行框架JQuery、DWR、Struts1/2，Hibernate，Spring，MyBatis、JBPM、Lucene等有深入研究。授课逻辑严谨，条理清晰，注重学生独立解决问题的能力。</p>
                                        <!-- <p><span>难度等级</span>中级</p>
                                         <p><span>课程时长</span>8-16小时/周，共4周</p>
                                         <p><span>如何通过</span>通过所有的作业及考核，作业共4份，考核为一次终极考核</p>
                                         <p><span>用户评分</span>平均用户评分 <em>4.9</em> <a href="#">查看全部评价</a></p>
                                         <p><span>课程价格</span>特惠价格<em>￥999</em> <i> 原价1999 </i></p>-->
                                    </div>
                                </div>

                            </div>
                            <div class="content-com about">
                                <div class="title"><span>课程介绍</span></div>
                                <div class="cont cktop">
                                    <div>
                                        <p>${model.courseBase.description!""}</p>
                                    </div>
                                    <!--<span class="on-off">更多 <i class="i-chevron-bot"></i></span>-->
                                </div>
                            </div>
                            <div class="content-com prob">
                                <div class="title"><span>常见问题</span></div>
                                <div class="cont">
                                    <ul>
                                        <li class="item"><span class="on-off"><i class="i-chevron-bot"></i> 我什么时候能够访问课程视频与作业？</span>
                                            <div class="drop-down">
                                                <p>
                                                    课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。</p>
                                            </div>
                                        </li>
                                        <li class="item"><span class="on-off"><i class="i-chevron-bot"></i> 如何需要额外的时间来完成课程会怎么样？</span>
                                            <div class="drop-down">
                                                <p>
                                                    课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。</p>
                                            </div>
                                        </li>
                                        <li class="item"><span class="on-off"><i class="i-chevron-bot"></i> 我支付次课程之后会得到什么？</span>
                                            <div class="drop-down">
                                                <p>
                                                    课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。</p>
                                            </div>
                                        </li>
                                        <li class="item"><span class="on-off"><i class="i-chevron-bot"></i> 退款条例是如何规定的？</span>
                                            <div class="drop-down">
                                                <p>
                                                    课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。</p>
                                            </div>
                                        </li>
                                        <li class="item"><span class="on-off"><i
                                                        class="i-chevron-bot"></i> 有助学金？</span>
                                            <div class="drop-down">
                                                <p>
                                                    课程安排灵活，课程费用支付提供180天全程准入和资格证书。自定进度课程建议的最后期限，但你不会受到惩罚错过期限，只要你赚你的证书在180天内。以会话为基础的课程可能要求你在截止日期前保持正轨，但如果你落后了，你可以切换到以后的会议，你完成的任何工作将与你转移。</p>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--侧边栏-->
                    <!--#include virtual="/include/course_detail_side.html"-->
                    <!--侧边栏-->

                </div>
            </div>
            <div class="articleItem" style="display: none">
                <div class="article-cont-catalog">
                    <div class="article-left-box">
                        <div class="content">
                            <#list model.teachplans as firstNode>
                                <div class="item">
                                    <div class="title act"><i class="i-chevron-top"></i>${firstNode.pname}<span
                                                class="time">x小时</span></div>
                                    <div class="drop-down" style="height: 260px;">
                                        <ul class="list-box">
                                            <#list firstNode.teachPlanTreeNodes as secondNode>
                                                <li>
                                                    <a href="http://www.xuecheng-plus.com/course/preview/learning.html?id=${model.courseBase.id}&chapter=<#if secondNode.teachplanMedia??>${secondNode.teachplanMedia.teachplanId!''}<#else>''</#if>"
                                                       target="_blank">${secondNode.pname}</a></li>
                                            </#list>
                                        </ul>
                                    </div>
                                </div>
                            </#list>
                            <#-- <div class="item">
                                 <div class="title act"><i class="i-chevron-top"></i>第一阶段 HTTP协议基础详解<span class="time">8小时</span></div>
                                 <div class="about">使用Java消息中间件处理异步消息成为了分布式系统中的必修课，通过本门课程可以深入浅出的学习如何在Java中使用消息中间件并且一步一步打造更优雅的最佳实践方案。</div>
                                 <div class="drop-down" style="height: 260px;">
                                     <ul class="list-box">
                                         <li class="active">1.1 阅读：分级政策细节 <span>97’33”</span></li>
                                         <li>1.2 视频：为什么分为 A 部分、B 部分、C 部分 <span>66’15”</span></li>
                                         <li>1.3 视频：软件安装介绍 <span>86’42”</span></li>
                                         <li>1.4 阅读：Emacs安装 <span>59’00”</span></li>
                                         <li>1.5 作业1：Emacs安装 <span>93’29”</span></li>
                                         <li>阶段测试</li>
                                     </ul>
                                 </div>
                             </div>-->


                        </div>
                    </div>
                    <!--侧边栏-->
                    <!--#include virtual="/include/course_detail_side.html"-->
                    <!--侧边栏-->
                </div>
            </div>
            <div class="artcleAsk" style="display: none">
                <div class="article-cont-ask">
                    <div class="article-left-box">
                        <div class="content">
                            <div class="content-title">
                                <p><a class="all">全部</a><a>精选</a><a>我的</a></p>
                                <p>
                                    <a class="all">全部</a><span><a>1.1</a><a>1.2</a><a>1.3</a><a>1.4</a><a>1.5</a></span><a
                                            href="$" class="more">更多 <i class="i-chevron-bot"></i></a></p>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p class="title">如何用微服务重构应用程序?</p>
                                    <p><span>我来回答</span></p>
                                    <p>2017-3-20 <span><i></i>回答2</span><span><i></i>浏览2</span></p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p class="title">如何用微服务重构应用程序?</p>
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。
                                        【最新 <i class="new">心跳347890</i> 的回答】</p>
                                    <p>2017-3-20 <span class="action-box"><span><i
                                                        class="i-answer"></i>回答 2</span><span><i class="i-browse"></i>浏览 12</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p class="title">如何用微服务重构应用程序?</p>
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。
                                        【最新 <i class="new">心跳347890</i> 的回答】</p>
                                    <p>2017-3-20 <span class="action-box"><span><i
                                                        class="i-answer"></i>回答 2</span><span><i class="i-browse"></i>浏览 12</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p class="title">如何用微服务重构应用程序?</p>
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。
                                        【最新 <i class="new">心跳347890</i> 的回答】</p>
                                    <p>2017-3-20 <span class="action-box"><span><i
                                                        class="i-answer"></i>回答 2</span><span><i class="i-browse"></i>浏览 12</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p class="title">如何用微服务重构应用程序?</p>
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。
                                        【最新 <i class="new">心跳347890</i> 的回答】</p>
                                    <p>2017-3-20 <span class="action-box"><span><i
                                                        class="i-answer"></i>回答 2</span><span><i class="i-browse"></i>浏览 12</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p class="title">如何用微服务重构应用程序?</p>
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，仔细观察微服务的内容和时间是很重要的。以下两个要点将会对任何微服务重构策略产生重大影响。
                                        【最新 <i class="new">心跳347890</i> 的回答】</p>
                                    <p>2017-3-20 <span class="action-box"><span><i
                                                        class="i-answer"></i>回答 2</span><span><i class="i-browse"></i>浏览 12</span></span>
                                    </p>
                                </div>
                            </div>

                            <div class="itemlast">
                                <a href="#" class="overwrite">显示更多问题</a>
                            </div>
                        </div>
                    </div>
                    <!--侧边栏-->
                    <!--#include virtual="/include/course_detail_side.html"-->
                    <!--侧边栏-->
                </div>
            </div>
            <div class="artcleNot" style="display: none;">
                <div class="article-cont-note">
                    <div class="article-left-box">
                        <div class="content">
                            <div class="content-title">
                                <p><a class="all">全部</a><a>精选</a><a>我的</a></p>
                                <p>
                                    <a class="all">全部</a><span><a>1.1</a><a>1.2</a><a>1.3</a><a>1.4</a><a>1.5</a></span><a
                                            href="$" class="more">更多 <i class="i-chevron-bot"></i></a></p>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <span class="video-time"><i class="i-play"></i>2`10`</span>
                                    <p><img src="/static/img/widget-demo.png" width="221" alt=""></p>
                                    <p class="action-box">4小时前 <span class="active-box"><span><i class="i-coll"></i>采集</span><span><i
                                                        class="i-laud"></i>赞</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，<br>仔细观察微服务的内容和时间是很重要的。<br>以下两个要点将会对任何微服务重构策略产生重大影响。
                                    </p>
                                    <p class="action-box">4小时前 <span class="active-box"><span><i class="i-edt"></i>编辑</span><span><i
                                                        class="i-del"></i>删除</span><span><i
                                                        class="i-laud"></i>赞</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，<br>仔细观察微服务的内容和时间是很重要的。<br>以下两个要点将会对任何微服务重构策略产生重大影响。
                                    </p>
                                    <p class="action-box">4小时前 <span class="active-box"><span><i class="i-edt"></i>编辑</span><span><i
                                                        class="i-del"></i>删除</span><span><i
                                                        class="i-laud"></i>赞</span></span>
                                    </p>
                                </div>
                            </div>
                            <div class="item">
                                <div class="item-left">
                                    <p><img src="/static/img/widget-myImg.jpg" width="60px" alt=""></p>
                                    <p>毛老师</p>
                                </div>
                                <div class="item-right">
                                    <p>在讨论如何将重构转化为微服务之前，退后一步，<br>仔细观察微服务的内容和时间是很重要的。<br>以下两个要点将会对任何微服务重构策略产生重大影响。
                                    </p>
                                    <p class="action-box">4小时前 <span class="active-box"><span><i class="i-edt"></i>编辑</span><span><i
                                                        class="i-del"></i>删除</span><span><i
                                                        class="i-laud"></i>赞</span></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--侧边栏-->
                    <!--#include virtual="/include/course_detail_side.html"-->
                    <!--侧边栏-->
                </div>
            </div>
            <div class="artcleCod" style="display: none;">
                <div class="article-cont">
                    <div class="article-left-box">
                        <div class="comment-box">
                            <div class="evaluate">
                                <div class="eva-top">
                                    <div class="tit">课程评分</div>
                                    <div class="star">
                                        <div class="score"><i>5</i></div>
                                    </div>
                                    <span class="star-score"> <i>5</i> 分</span></div>
                                <div class="eva-cont">
                                    <div class="tit">学员评语</div>
                                    <div class="text-box">
                                        <textarea class="form-control" rows="5"
                                                  placeholder="扯淡、吐槽、表扬、鼓励......想说啥说啥！"></textarea>
                                        <div class="text-right"><span>发表评论</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="course-evaluate">
                                <div class="top-tit">评论
                                    <span>
                        <label><input name="eval" type="radio" value="" checked/> 所有学生 </label>
                        <label><input name="eval" type="radio" value=""/> 完成者 </label>
                    </span>
                                </div>
                                <div class="top-cont">
                                    <div class="cont-top-left">
                                        <div class="star-scor">
                                            <div class="star-show">
                                                <div class="score"><i>5</i></div>
                                            </div>
                                            <div class="scor">4.9分</div>
                                        </div>
                                        <div class="all-scor">总评分：12343</div>
                                    </div>
                                    <div class="cont-top-right">
                                        <div class="star-grade">五星
                                            <div class="grade">
                                                <div class="grade-percent"><span></span></div>
                                                <div class="percent-num"><i>95</i>%</div>
                                            </div>
                                        </div>
                                        <div class="star-grade">四星
                                            <div class="grade">
                                                <div class="grade-percent"><span></span></div>
                                                <div class="percent-num"><i>5</i>%</div>
                                            </div>
                                        </div>
                                        <div class="star-grade">三星
                                            <div class="grade">
                                                <div class="grade-percent"><span></span></div>
                                                <div class="percent-num"><i>0</i>%</div>
                                            </div>
                                        </div>
                                        <div class="star-grade">二星
                                            <div class="grade">
                                                <div class="grade-percent"><span></span></div>
                                                <div class="percent-num"><i>2</i>%</div>
                                            </div>
                                        </div>
                                        <div class="star-grade">一星
                                            <div class="grade">
                                                <div class="grade-percent"><span></span></div>
                                                <div class="percent-num"><i>1</i>%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-item-box">
                                    <div class="title">评论 <span>12453条评论</span></div>
                                    <div class="item">
                                        <div class="item-left">
                                            <p><img src="/static/img/widget-pic.png" width="60px" alt=""></p>
                                            <p>毛老师</p>
                                        </div>
                                        <div class="item-cent">
                                            <p>
                                                很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！</p>
                                            <p class="time">2017-2-43</p>
                                        </div>
                                        <div class="item-rit">
                                            <p>
                                            <div class="star-show">
                                                <div class="score"><i>4</i></div>
                                            </div>
                                            </p>
                                            <p>评分 <span>5星</span></p>
                                        </div>
                                    </div>
                                    <div class="item">
                                        <div class="item-left">
                                            <p><img src="/static/img/widget-pic.png" width="60px" alt=""></p>
                                            <p>毛老师</p>
                                        </div>
                                        <div class="item-cent">
                                            <p>
                                                很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！</p>
                                            <p class="time">2017-2-43</p>
                                        </div>
                                        <div class="item-rit">
                                            <p>
                                            <div class="star-show">
                                                <div class="score"><i>5</i></div>
                                            </div>
                                            </p>
                                            <p>评分 <span>5星</span></p>
                                        </div>
                                    </div>
                                    <div class="item">
                                        <div class="item-left">
                                            <p><img src="/static/img/widget-pic.png" width="60px" alt=""></p>
                                            <p>毛老师</p>
                                        </div>
                                        <div class="item-cent">
                                            <p>
                                                很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！</p>
                                            <p class="time">2017-2-43</p>
                                        </div>
                                        <div class="item-rit">
                                            <p>
                                            <div class="star-show">
                                                <div class="score"><i>5</i></div>
                                            </div>
                                            </p>
                                            <p>评分 <span>5星</span></p>
                                        </div>
                                    </div>
                                    <div class="item">
                                        <div class="item-left">
                                            <p><img src="/static/img/widget-pic.png" width="60px" alt=""></p>
                                            <p>毛老师</p>
                                        </div>
                                        <div class="item-cent">
                                            <p>
                                                很受用，如果再深入下就更好了。虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！虽然都是入门级别的，但是也很使用，后续就需要自己发挥了！</p>
                                            <p class="time">2017-2-43</p>
                                        </div>
                                        <div class="item-rit">
                                            <p>
                                            <div class="star-show">
                                                <div class="score"><i>5</i></div>
                                            </div>
                                            </p>
                                            <p>评分 <span>5星</span></p>
                                        </div>
                                    </div>
                                    <div class="get-more">页面加载中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--侧边栏-->
                    <!--#include virtual="/include/course_detail_side.html"-->
                    <!--侧边栏-->
                </div>
            </div>
        </div>
    </div>
    <div class="popup-course">
        <div class="mask"></div>
        <!--欢迎访问课程弹窗- start -->
        <div class="popup-course-box">
            <div class="title">${model.courseBase.name} <span class="close-popup-course-box">×</span></div>
            <div class="content">
                <p>欢迎学习本课程，本课程免费您可以立即学习，也可加入我的课程表享受更优质的服务。</p>
                <p><a href="#" @click.prevent="addCourseTable()">加入我的课程表</a> <a href="#"
                                                                                       @click.prevent="startLearngin()">立即学习</a>
                </p>
            </div>
        </div>
    </div>
    <div class="popup-box">
        <div class="mask"></div>
        <!--支付弹窗- start -->
        <div class="popup-pay-box">
            <div class="title">${model.courseBase.name} <span class="close-popup-pay-box">×</span></div>
            <div class="content">
                <img :src="qrcode" width="200" height="200" alt="请点击支付宝支付按钮，并完成扫码支付。"/>

                <div class="info">
                    <p class="info-tit">${model.courseBase.name}<span>课程有效期:${model.courseBase.validDays}天</span>
                    </p>
                    <p class="info-pic">课程价格 : <span>￥${model.courseBase.originalPrice!''}元</span></p>
                    <p class="info-new-pic">优惠价格 : <span>￥${model.courseBase.price!''}元</span></p>
                </div>
            </div>
            <div class="fact-pic">实际支付: <span>￥${model.courseBase.price!''}元</span></div>
            <div class="go-pay"><a href="#" @click.prevent="wxPay()">微信支付</a><a href="#" @click.prevent="aliPay()">支付宝支付</a><a
                        href="#" @click.prevent="startLearngin()">试学</a></div>
        </div>
        <!--支付弹窗- end -->
        <div class="popup-comment-box">

        </div>
    </div>
    <!-- 页面底部 -->
    <!--底部版权-->
    <!--#include virtual="/include/footer.html"-->
    <!--底部版权-->
</div>
<script type="text/javascript" src="/static/plugins/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="/static/plugins/bootstrap/dist/js/bootstrap.js"></script>
<script>
    var courseId = "${model.courseBase.id}";
    var courseCharge = "${model.courseBase.charge}"
    $(function (){
        $('.article-cont a').click(function (){
            //获取点击的元素给其添加样式，讲其兄弟元素的样式移除
            $(this).addClass("active").siblings().removeClass("active");
            //获取选中元素的下标
            var index = $(this).index();
            $(this).parent().siblings().children().eq(index).css({"display": "block"}).siblings().css({"display": "none"});
        });
    })

</script>
</body>

```

##### 数据模型

```java
@ApiModel("课程预览信息")
@Data
public class CoursePreviewDto {
    @ApiModelProperty(value = "课程基本信息,课程营销信息")
   private CourseBaseInfoDto courseBase;

    @ApiModelProperty(value = "课程计划信息")
    private  List<TeachplanDto> teachplans;
}
```

```java
@ApiModel("课程信息")
@Data
public class CourseBaseInfoDto extends CourseBase {
    @ApiModelProperty(value = "费规则，对应数据字典", example = "")
    private String charge;
    @ApiModelProperty(value = "价格", example = "1")
    private Float price;
    @ApiModelProperty(value = "原价", example = "1")
    private Float originalPrice;
    @ApiModelProperty(value = "咨询qq", example = "")
    private String qq;
    @ApiModelProperty(value = "微信", example = "")
    private String wechat;
    @ApiModelProperty(value = "电话", example = "")
    private String phone;
    @ApiModelProperty(value = "有效期天数", example = "1")
    private Integer validDays;
    @ApiModelProperty(value = "大分类名称", example = "")
    private String mtName;
    @ApiModelProperty(value = "小分类名称", example = "")
    private String stName;
}
```

```java
@Data
@ApiModel(value = "TeachplanDTO", description = "课程计划")
public class TeachplanDto extends Teachplan {
    @ApiModelProperty(value = "课程计划关联的媒资信息")
    private TeachplanMedia teachplanMedia;
    @ApiModelProperty(value = "子目录")
    private List<TeachplanDto> teachPlanTreeNodes;
}

```

```java
@Data
@ApiModel(value="TeachplanMedia", description="")
public class TeachplanMedia implements Serializable {
    private static final long serialVersionUID = 1L;
    @ApiModelProperty(value = "主键")
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;
    @ApiModelProperty(value = "媒资文件id")
    private String mediaId;
    @ApiModelProperty(value = "课程计划标识")
    private Long teachplanId;
    @ApiModelProperty(value = "课程标识")
    private Long courseId;
    @ApiModelProperty(value = "媒资文件原始名称")
    private String mediaFilename;
    private LocalDateTime createDate;
    @ApiModelProperty(value = "创建人")
    private String createPeople;
    @ApiModelProperty(value = "修改人")
    private String changePeople;
}

```

##### Mapper

```java 
public interface CoursePublishMapper extends BaseMapper<CoursePublish> {
}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xuecheng.content.mapper.CoursePublishMapper">
</mapper>
```



##### 服务类

CoursePublishService类添加以下接口

```java
public interface CoursePublishService extends IService<CoursePublish> {
/***
     * 根据课程id获取课程预览信息
     * @param courseId
     * @return {@link CoursePreviewDto }
     * @author hmxchen
     * @date 2023/2/9 21:14
    */
    CoursePreviewDto getCoursePreviewDto(Long courseId);
}
```

CoursePublishServiceImpl实现

```java 
@Slf4j
@Service
public class CoursePublishServiceImpl extends ServiceImpl<CoursePublishMapper, CoursePublish> implements CoursePublishService {
    @Resource
    private CourseBaseService courseBaseService;
    @Resource
    private TeachplanService teachplanService;
    @Override
    public CoursePreviewDto getCoursePreviewDto(Long courseId) {
        CoursePreviewDto coursePreviewDto = new CoursePreviewDto();
        coursePreviewDto.setCourseBase(courseBaseService.getCourseBaseInfo(courseId));
        coursePreviewDto.setTeachplans(teachplanService.findTeachplanTree(courseId));
        return coursePreviewDto;
    }
}
```

#### 测试

接口测试需要将测试环境先准备好

在课程预览界面上要加载css、js、图片等内容，

这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求

1、在本机安装 Nginx ，从课程资料目录获取nginx-1.23.1.zip并解压。

2、运行nginx-1.23.1目录下的nginx.exe。

默认端口为80，如果本机80端口被占用，则需要杀掉占用进程后再启动nginx。

如果无法杀掉80端口占用进程则需要修改nginx-1.23.1目录下conf/nginx.conf配置文件

将80端口修改为空闲端口。

启动nginx，访问http://localhost 出现下边的网页表示启动成功

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-18.png){width="5.90625in" height="0.9270833333333334in"}

下边开始部署前端工程：

1、从课程资料目录获取xc-ui-pc-static-portal.zip 并解压。

2、修改本机hosts文件，加入127.0.0.1 www.xuecheng-plus.com。

window10操作系统hosts文件在C:\\Windows\\System32\\drivers\\etc下

Centos7操作系统的hosts文件在/etc目录下。

在hosts文件加入如下配置

``` 
127.0.0.1 www.xuecheng-plus.com file.xuecheng-plus.com ucenter.xuecheng-plus.com teacher.xuecheng-plus.com
```

3.course_template.html是一个静态html页面，里边还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容。

course_template.html文件在xc-ui-pc-static-portal\\course目录下

![](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/01/29/20230129004448-23.png){width="4.541666666666667in" height="1.9791666666666667in"}

4.在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问 ： file.xuecheng-plus.com

在nginx-1.23.1目录中找到conf目录，配置目录下的nginx.conf文件。

配置内容如下：

```
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    
    upstream fileserver{
        server 127.0.0.1:9000 weight=10;
    }
    upstream gatewayserver{
        server 127.0.0.1:63010 weight=10;
    }
    server {
        listen       80;
        server_name   file.xuecheng-plus.com;
        # 识别html的include的关键
        ssi on;
        ssi_silent_errors on;
        location /video  {
            proxy_pass http://fileserver;
        }
         location /mediafiles  {
            proxy_pass http://fileserver;
        }
    }
    server {
        listen       80;
        server_name   www.xuecheng-plus.com localhost;
        # 识别html的include的关键
        ssi on;
        ssi_silent_errors on;
        #charset koi8-r;
        # 静态缓存不使用缓存
        expires -1;
        if_modified_since off;
        add_header Last-Modified "";
        add_header Cache-Control no-cache;
        etag off;
        location / {
            # 门户静态页面的根路径：
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/;
            index index.html index.htm;
        }
        location  /static/img/ {
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/img/;
        }
        location  /static/css/ {
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/css/;
        }
        location  /static/js/ {
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/js/;
        }
        location  /static/plugins/ {
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/plugins/;
            add_header Access-Control-Allow-Origin http://ucenter.xuecheng-plus.com;
            add_header Access-Control-Allow-Credentials true;
            add_header Access-Control-Allow-Methods GET;
        }
        location  /plugins/ {
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/plugins/;
        }
        location /course/preview/learning.html {
            alias D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal/course/learning.html;
        }
        location /course/search.html {
            root D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal;
        }
        location /course/learning.html {
            root D:/project/learn_video/xuecheng-online/xuecheng-plus-ui/xc-ui-pc-static-portal;
        }
        //后台接口地址
        location /api {
            proxy_pass http://gatewayserver;
        }
        location /open/content/ {
            proxy_pass http://gatewayserver/content/open/;
        }
        location /open/media/ {
            proxy_pass http://gatewayserver/media/open/;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}

```



 **为什么停止了nginx服务还能打开网页**

1\. **原因**

因为启动了两次服务，开启了多个进程，所以关掉之后仍然可以打开网页。

 **2. 表象**

启动了多次nginx服务器，运行第二次`nginx -s stop`命令来关闭服务器时，报如下错误：  
`nginx: [error] CreateFile() "E:\xxx\nginx-1.22.0/logs/nginx.pid" failed (2: The system cannot find the file specified)`。为什么呢？nginx.pid文件会记录服务进程pid，两次启动可能最后一次启动的进程会覆盖第一次的文件，因此关闭服务器之后，只是关闭了最后一次的服务进程，而前面的进程都仍在运行，所以还能打开网页（ps:这段是我个人猜测，大概率不是这样，没有往下研究，知道的麻烦来指导一下吧···）。  
![在这里插入图片描述](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/02/12/20230212173724.png)  
那通过`tasklist /fi "imagename eq nginx.exe"`来看一下进程吧，果然还有进程在运行：  
![在这里插入图片描述](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/02/12/20230212173724.png)  
再通过任务管理器看看吧，确实也还在：  
![在这里插入图片描述](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/02/12/20230212173723.png)

**解决方法**

1.  通过任务管理器的来关吧，找到nginx.exe进程结束任务就好了，然后再通过`tasklist /fi "imagename eq nginx.exe"`命令或者打开网页看看服务还在不在，还在的话再通过任务管理器关闭，如此往复循环直到再无进程。
2.  通过命令来关闭。  
    通过`tasklist /fi "imagename eq nginx.exe"`可以看到进程的pid，如图二所示。然后通过`taskkill -t -f /pid pid号`命令来关闭进程就解决了，如下图所示。  
    ![在这里插入图片描述](http://mxchen-figure-bed.oss-cn-hangzhou.aliyuncs.com/img/2023/02/12/20230212173724.png)

 



### 课程审核



运营人员审核

1.记录是否是待审核的

2.新增审核记录

3.修改course_publish_pre 的审核状态

### 课程发布



### 课程搜索





